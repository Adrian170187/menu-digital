<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Caja - Men√∫ Digital</title>
  <link rel="stylesheet" href="css/styles.css">
</head>

<body data-role="caja">
  <header>
    <div class="container">
      <h1>üí∞ Caja y Facturaci√≥n</h1>
      <div style="display: flex; gap: 10px;">
        <button class="btn-primary" onclick="showStock()">üì¶ Gestionar Stock</button>
        <button class="btn-primary" onclick="showReport()">üìä Reporte del D√≠a</button>
      </div>
      <div class="nav-links">
        <button onclick="App.auth.logout()"
          style="background:none; color: var(--accent-color); font-size: 0.9rem; padding: 0;">Cerrar Sesi√≥n</button>
      </div>
    </div>
  </header>

  <main class="container">
    <h2>Mesas</h2>
    <div id="tables-grid" class="grid">
      <!-- Tables injected here -->
      <p>Cargando mesas...</p>
    </div>
  </main>

  <!-- Report Modal -->
  <div class="modal" id="report-modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>Reporte Diario</h2>
        <button class="close-modal" onclick="closeReport()">&times;</button>
      </div>
      <div id="report-content">
        <!-- Sales stats -->
      </div>
      <div style="margin-top: 20px; text-align: right; border-top: 1px solid #333; padding-top: 20px;">
        <button class="btn-danger" onclick="App.closeDay()">üîí Cerrar D√≠a (Borrar Datos)</button>
      </div>
    </div>
  </div>

  <!-- Stock Management Modal -->
  <div class="modal" id="stock-modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Gesti√≥n de Stock</h2>
        <button class="close-modal" onclick="closeStock()">&times;</button>
      </div>
      <div id="stock-content" style="max-height: 400px; overflow-y: auto;">
        <!-- Stock items injected here -->
      </div>
      <div style="margin-top: 20px; text-align: right;">
        <button class="btn-success" onclick="closeStock()">ListoS</button>
      </div>
    </div>
  </div> <!-- Close Table Confirmation Modal -->
  <div class="modal" id="close-table-modal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
      <div class="modal-header">
        <h2>Confirmar Cierre</h2>
        <button class="close-modal" onclick="closeCloseTableModal()">&times;</button>
      </div>
      <div>
        <p style="font-size: 1.1rem; margin-bottom: 20px;">¬øCobrar y liberar <strong id="close-modal-table-name">Mesa
            X</strong>?</p>
        <p style="font-size: 1.5rem; color: var(--primary-color); font-weight: bold; margin-bottom: 30px;"
          id="close-modal-total">$0</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button class="btn-secondary" onclick="closeCloseTableModal()">Cancelar</button>
          <button class="btn-success" id="btn-confirm-close-table">‚úÖ Confirmar Cobro</button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/menu-data.js"></script>
  <script src="js/app.js?v=3"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let tableToClose = null;

      const refreshTables = () => {
        const grid = document.getElementById('tables-grid');
        grid.innerHTML = '';

        for (let i = 1; i <= App.data.totalTables; i++) {
          const table = App.data.tables[i] || { status: 'free', total: 0 };
          const isOccupied = table.status === 'occupied';

          const card = document.createElement('div');
          card.className = `card ${isOccupied ? 'occupied' : 'free'}`;
          card.style.border = isOccupied ? '2px solid var(--primary-color)' : '1px solid #333';

          card.innerHTML = `
            <h3>Mesa ${i}</h3>
            <p style="font-size: 0.8rem; margin-bottom: 10px;">Estado: <strong>${isOccupied ? 'OCUPADA' : 'LIBRE'}</strong></p>
            ${isOccupied ? `
              <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-color); margin-bottom: 15px;">
                ${App.formatCurrency(table.total)}
              </div>
              <button class="btn-primary" onclick="promptCloseTable(${i})" style="width: 100%;">Cobrar y Cerrar</button>
            ` : `
              <div style="font-size: 1.2rem; opacity: 0.3; margin-bottom: 15px;">-</div>
              <button class="btn-secondary" disabled style="width: 100%; opacity: 0.5;">Cerrar Mesa</button>
            `}
          `;
          grid.appendChild(card);
        }
      };

      // Initial render
      setTimeout(refreshTables, 500);
      window.addEventListener('tables-updated', refreshTables);
      window.addEventListener('state-reloaded', refreshTables);

      window.promptCloseTable = (id) => {
        console.log("Solicitando cierre de mesa:", id);
        tableToClose = parseInt(id);
        const table = App.data.tables[tableToClose];
        if (table) {
          document.getElementById('close-modal-table-name').innerText = `Mesa ${id}`;
          document.getElementById('close-modal-total').innerText = App.formatCurrency(table.total);
          document.getElementById('close-table-modal').classList.add('active');
        } else {
          console.error("Mesa no encontrada:", id);
          alert("Error: No se encontro la mesa " + id);
        }
      };

      window.closeCloseTableModal = () => {
        document.getElementById('close-table-modal').classList.remove('active');
        tableToClose = null;
      };

      document.getElementById('btn-confirm-close-table').onclick = () => {
        if (tableToClose) {
          try {
            console.log("Intentando cerrar mesa:", tableToClose);
            const result = App.closeTable(tableToClose);
            if (result) {
              // Success
              closeCloseTableModal();
              // Delay alert slightly to let UI update
              setTimeout(() => alert("Mesa cobrada y liberada correctamente."), 100);
            } else {
              alert("No se pudo cerrar la mesa. Verifica si ya estaba libre.");
            }
          } catch (e) {
            console.error("Error al cerrar mesa:", e);
            alert("Error del sistema al cerrar mesa: " + e.message);
          }
        } else {
          alert("Error: No hay mesa seleccionada.");
        }
      };

      window.showReport = () => {
        const modal = document.getElementById('report-modal');
        const content = document.getElementById('report-content');

        const sales = App.data.sales;
        const totalSales = sales.reduce((sum, s) => sum + s.total, 0);
        const totalAdults = sales.reduce((sum, s) => sum + (s.adults || 0), 0);
        const totalChildren = sales.reduce((sum, s) => sum + (s.children || 0), 0);
        const itemReport = App.getItemsSoldReport();
        const beverageReport = App.getBeverageStockReport();

        let html = `
          <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <div>
              <h3>Ventas: ${sales.length}</h3>
              <p>üë• ${totalAdults} Adultos | ${totalChildren} Ni√±os</p>
            </div>
            <h3 class="price">Ingresos: ${App.formatCurrency(totalSales)}</h3>
          </div>

          <h4>üì¶ Balance de Bebidas:</h4>
          <table class="data-table" style="margin-bottom: 25px;">
            <thead>
              <tr>
                <th>Bebida</th>
                <th>Stock Inicial</th>
                <th>Vendidas</th>
                <th>Stock Final</th>
              </tr>
            </thead>
            <tbody>
              ${beverageReport.map(b => `
                <tr>
                  <td>${b.name}</td>
                  <td>${b.totalStock}</td>
                  <td>${b.soldToday}</td>
                  <td><strong>${b.currentStock}</strong></td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <h4>üçî Detalle por Producto:</h4>
          <table class="data-table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Total Generado</th>
              </tr>
            </thead>
            <tbody>
              ${Object.keys(itemReport).map(name => `
                <tr>
                  <td>${name}</td>
                  <td>${itemReport[name].quantity}</td>
                  <td>${App.formatCurrency(itemReport[name].total)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <br>
          <h4>üßæ Historial de Transacciones:</h4>
          <ul style="max-height: 150px; overflow-y: auto; padding-left: 20px;">
            ${sales.map(s => {
          const time = new Date(s.timestamp).toLocaleTimeString();
          const pax = `(Ad: ${s.adults || 0}, Ni: ${s.children || 0})`;
          return `<li style="margin-bottom: 5px;">
                    <strong>${time}</strong> - Mesa ${s.tableId} ${pax}: ${App.formatCurrency(s.total)}
                </li>`;
        }).join('')}
          </ul>
        `;

        content.innerHTML = html;
        modal.classList.add('active');
      };

      window.closeReport = () => {
        document.getElementById('report-modal').classList.remove('active');
      };

      window.showStock = () => {
        const modal = document.getElementById('stock-modal');
        const content = document.getElementById('stock-content');

        if (!App.data.menu) return alert("Cargando men√∫...");

        let html = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Stock Actual</th>
                  <th>Acci√≥n</th>
                </tr>
              </thead>
              <tbody>
          `;

        App.data.menu.categories.forEach(cat => {
          html += `<tr style="background: #1a1a1a"><td colspan="3"><strong>${cat.name}</strong></td></tr>`;
          cat.items.forEach(item => {
            html += `
                <tr>
                  <td>${item.name}</td>
                  <td>
                    <input type="number" id="stock-input-${item.id}" value="${item.stock}" 
                      style="width: 60px; background:#222; color:white; border:1px solid #444; padding:5px; border-radius:4px;">
                  </td>
                  <td>
                    <button class="btn-secondary" onclick="updateItemStock(${item.id})" style="padding: 5px 10px; font-size: 0.8rem;">Actualizar</button>
                  </td>
                </tr>
              `;
          });
        });

        html += `</tbody></table>`;
        content.innerHTML = html;
        modal.classList.add('active');
      };

      window.closeStock = () => {
        document.getElementById('stock-modal').classList.remove('active');
      };

      window.updateItemStock = (id) => {
        const input = document.getElementById(`stock-input-${id}`);
        const newValue = parseInt(input.value);
        if (isNaN(newValue) || newValue < 0) return alert("Por favor ingrese un n√∫mero v√°lido.");

        if (App.updateStock(id, newValue)) {
          alert("Stock actualizado.");
        }
      };

      // Re-render functions when storage changes
      window.addEventListener('storage', () => {
        if (document.getElementById('report-modal').classList.contains('active')) showReport();
        if (document.getElementById('stock-modal').classList.contains('active')) showStock();
      });
    });
  </script>
</body>

</html>